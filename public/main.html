
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Maitre d&#39;Tucha | Welcome!</title>
        
        <!-- <link rel="stylesheet" href="http://cdn.webix.com/edge/webix.css" /> -->
		<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
		<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.3/backbone-min.js"></script>

		<script src="/skin.js"></script>
		
		<script>
			var skin  = new Skin();
			var theme = skin.run();				
		</script>
		
        <script src="http://cdn.webix.com/edge/webix.js"></script>    

    </head>
    <body>
	
    <script src="/i18n.js"></script>
    <script src="/settings.js"></script>
    <script src="/proxy.js"></script>
    <script src="/components.js"></script>
    <script src="/controller.js"></script>
    <script src="/route.js"></script>

    <script>    
        webix.ready(function(){            
            // load Local Storage setting
			timezone      = {};
            route         = new Route();
            local_storage = new LocalStorage ();
            global_setting_ls = local_storage.get( global_setting.localStorage.key );
                if( global_setting_ls ){
                    global_setting = global_setting_ls;
                }
            //
            i18n        = new my_i18n();
            localizator = i18n.set( global_setting.i18n.locale );
            //
            components = new Components();
            //
            controller = new Controller(components);			
			/*
                init
            */
            controller.auth({}, function(auth){
                if(auth){
					// user info
					controller.ajax.get("/snippet-component/0/user_info.json", function(data){
						global_setting.user = data.data;
						
						if (components.datatable[global_setting.datatable.id]) {
							route.navigate( components.datatable[global_setting.datatable.id].view.urlBase , { trigger: true });
						}

						components.init();
						
						// user top menu
						var top_menu = $$("top.menu");						
						if( top_menu ){
							var header_user = top_menu.getMenuItem("header.user");
							if( header_user ){
								header_user.value = global_setting.user.last_name + " " + global_setting.user.first_name;
								top_menu.refresh();
							}							
						}
						if ( $$('changeThemes') ) $$('changeThemes').setValue( theme );
						// themes
						controller.onChange( $$('changeThemes'), function( value ){
							window.location.href = "?theme="+value;
						});
					});
                }
                else{
                    route.navigate( "login", { trigger: true });
                    components.login();
                }
            });
			console.log( theme );			
            /*
                end init
            */
            console.log('Backbone.history.start' + Backbone.history.start());
            console.log('main.html OK');
            
        }); // ready    
    </script>
    </body>
</html>